<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>주차봉사자 작업표</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 네이버 스타일 폰트 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', Arial, sans-serif;
            background: #f8fafb;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 430px;
            margin: 18px auto 0 auto;
            padding: 0 8px 24px 8px;
        }
        h2 {
            font-size: 1.25em;
            font-weight: 700;
            color: #1ec800;
            margin: 0 0 12px 0;
            letter-spacing: -1px;
            text-align: left;
        }
        .controls {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .controls button {
            background: #1ec800;
            color: #fff;
            border: none;
            border-radius: 18px;
            font-size: 0.95em;
            font-weight: 500;
            padding: 7px 18px;
            box-shadow: 0 2px 8px rgba(30,200,0,0.08);
            cursor: pointer;
            transition: background 0.2s;
        }
        .controls button:hover {
            background: #17b300;
        }
        #shareMsg {
            font-size: 0.95em;
            margin-left: 6px;
            color: #1ec800;
        }
        .table-card {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07);
            padding: 12px 8px 16px 8px;
            margin-top: 2px;
            overflow-x: auto;
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            min-width: 320px;
            font-size: 0.97em;
        }
        th, td {
            border: none;
            padding: 7px 2px;
            text-align: center;
            min-width: 54px;
        }
        th {
            background: #e9f7e0;
            color: #1ec800;
            font-weight: 700;
            font-size: 1em;
            border-radius: 10px;
        }
        td {
            background: #f6f8f7;
            border-radius: 10px;
        }
        .dropdown-group {
            display: flex;
            flex-direction: column;
            gap: 3px;
            align-items: center;
        }
        select {
            font-size: 0.95em;
            height: 28px;
            width: 90px;
            min-width: 54px;
            border: 1px solid #c6e6c1;
            border-radius: 8px;
            background: #fff;
            color: #222;
            box-shadow: 0 1px 4px rgba(30,200,0,0.04);
            margin-bottom: 1px;
            transition: border 0.2s;
        }
        select:focus {
            border: 1.5px solid #1ec800;
            outline: none;
        }
        option:disabled {
            color: #bbb;
            background: #f2f2f2;
        }
        @media (max-width: 600px) {
            .container {
                max-width: 100vw;
                padding: 0 2vw 18px 2vw;
            }
            h2 {
                font-size: 1.08em;
            }
            .table-card {
                padding: 7px 2px 10px 2px;
            }
            th, td {
                padding: 5px 1px;
                min-width: 38px;
                font-size: 0.95em;
            }
            select {
                font-size: 0.92em;
                height: 22px;
                width: 60px;
                min-width: 38px;
            }
            .controls button {
                font-size: 0.92em;
                padding: 5px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>주차봉사자 작업표</h2>
        <div class="controls">
            <button id="toggleBtn">행/열 전환</button>
            <button id="shareBtn">공유 링크 복사</button>
            <span id="shareMsg"></span>
        </div>
        <div class="table-card" id="tableContainer"></div>
    </div>
    <script>
        // 봉사자 이름 목록
        const volunteers = [
            "최재영", "최성영", "송승재", "안재혁", "서채일", "장하현", "위건오", "박진우", "남재봉", "정재욱",
            "김지훈", "심규민", "박시원", "박지우", "손탁안", "장인수", "선주향", "김연경", "위하영", "선가영",
            "손다민", "강지연", "손효서", "전인화", "김다연", "박예진", "손소원", "박인혜", "한우리", "이미연"
        ];

        const days = ["월", "화", "수", "목", "금"];
        const times = ["말씀 전", "말씀 후"];
        const selectsPerCell = 2;

        // 데이터 구조: [행][열][셀별 드롭다운]
        let data = Array(times.length).fill().map(() =>
            Array(days.length).fill().map(() =>
                Array(selectsPerCell).fill("")
            )
        );

        let transposed = false;
        const STORAGE_KEY = "parking_volunteer_table_v2";

        function loadData() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has("data")) {
                try {
                    const decoded = decodeURIComponent(urlParams.get("data"));
                    const parsed = JSON.parse(atob(decoded));
                    if (validateData(parsed)) {
                        data = parsed;
                        saveData();
                        return;
                    }
                } catch (e) {}
            }
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (validateData(parsed)) {
                        data = parsed;
                    }
                } catch (e) {}
            }
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function validateData(d) {
            return Array.isArray(d) &&
                d.length === times.length &&
                d.every(row => Array.isArray(row) && row.length === days.length &&
                    row.every(cell => Array.isArray(cell) && cell.length === selectsPerCell));
        }

        function renderTable() {
            const container = document.getElementById("tableContainer");
            container.innerHTML = "";

            let table = document.createElement("table");
            let thead = document.createElement("thead");
            let tbody = document.createElement("tbody");

            if (!transposed) {
                let headRow = document.createElement("tr");
                let th = document.createElement("th");
                th.textContent = "";
                headRow.appendChild(th);
                days.forEach(day => {
                    let th = document.createElement("th");
                    th.textContent = day;
                    headRow.appendChild(th);
                });
                thead.appendChild(headRow);

                for (let r = 0; r < times.length; r++) {
                    let tr = document.createElement("tr");
                    let th = document.createElement("th");
                    th.textContent = times[r];
                    tr.appendChild(th);
                    for (let c = 0; c < days.length; c++) {
                        let td = document.createElement("td");
                        td.appendChild(createDropdownGroup(r, c));
                        tr.appendChild(td);
                    }
                    tbody.appendChild(tr);
                }
            } else {
                let headRow = document.createElement("tr");
                let th = document.createElement("th");
                th.textContent = "";
                headRow.appendChild(th);
                times.forEach(time => {
                    let th = document.createElement("th");
                    th.textContent = time;
                    headRow.appendChild(th);
                });
                thead.appendChild(headRow);

                for (let r = 0; r < days.length; r++) {
                    let tr = document.createElement("tr");
                    let th = document.createElement("th");
                    th.textContent = days[r];
                    tr.appendChild(th);
                    for (let c = 0; c < times.length; c++) {
                        let td = document.createElement("td");
                        td.appendChild(createDropdownGroup(c, r));
                        tr.appendChild(td);
                    }
                    tbody.appendChild(tr);
                }
            }

            table.appendChild(thead);
            table.appendChild(tbody);
            container.appendChild(table);
        }

        function createDropdownGroup(row, col) {
            const group = document.createElement('div');
            group.className = 'dropdown-group';

            let selectedNames = [];
            for (let r = 0; r < times.length; r++) {
                for (let i = 0; i < selectsPerCell; i++) {
                    if (data[r][col][i]) selectedNames.push(data[r][col][i]);
                }
            }

            for (let i = 0; i < selectsPerCell; i++) {
                const select = document.createElement('select');
                select.dataset.row = row;
                select.dataset.col = col;
                select.dataset.idx = i;

                const currentValue = data[row][col][i];

                let usedNames = [];
                for (let j = 0; j < selectsPerCell; j++) {
                    if (j !== i && data[row][col][j]) usedNames.push(data[row][col][j]);
                }

                let unavailable = selectedNames.filter(name => !usedNames.includes(name) || name !== currentValue);

                let emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = '선택';
                select.appendChild(emptyOption);

                volunteers.forEach(name => {
                    let option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    if (name !== currentValue && selectedNames.includes(name)) {
                        option.disabled = true;
                    }
                    select.appendChild(option);
                });

                select.value = currentValue;

                select.onchange = function() {
                    const r = parseInt(this.dataset.row);
                    const c = parseInt(this.dataset.col);
                    const idx = parseInt(this.dataset.idx);
                    data[r][c][idx] = this.value;
                    saveData();
                    renderTable();
                };

                group.appendChild(select);
            }
            return group;
        }

        document.getElementById("toggleBtn").onclick = function() {
            transposed = !transposed;
            renderTable();
        };

        document.getElementById("shareBtn").onclick = function() {
            const encoded = encodeURIComponent(btoa(JSON.stringify(data)));
            const url = `${location.origin}${location.pathname}?data=${encoded}`;
            navigator.clipboard.writeText(url).then(() => {
                document.getElementById("shareMsg").textContent = "공유 링크가 복사되었습니다!";
                setTimeout(() => {
                    document.getElementById("shareMsg").textContent = "";
                }, 2000);
            });
        };

        loadData();
        renderTable();
    </script>
</body>
</html>